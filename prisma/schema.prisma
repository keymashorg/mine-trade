// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// For local development with SQLite, use:
// datasource db {
//   provider = "sqlite"
//   url      = env("DATABASE_URL")
// }

// For production Postgres (Vercel):
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  sector        String   @default("A") // A, B, or C
  credits       Int      @default(500) // Starting credits
  journalUnlocks String  @default("") // Comma-separated unlock IDs: "metal_mastery,ultra_trio,biome_trio"
  moduleUnlocks String   @default("") // Comma-separated module IDs unlocked via journal
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  runs          Run[]
  vaultBalances VaultBalances?
  vaultSpecimens VaultSpecimen[]
  specimenListings SpecimenListing[]
  ownedRelics   OwnedRelic[]
  marketDumps   MarketDump[]
}

model Sector {
  id        String   @id @default("A") // A, B, or C
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Run {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      String   // "active", "won", "lost"
  currentDay  Int      @default(1)
  rigHP       Int      @default(10)
  rigDamage   Int      @default(0) // Accumulated damage this day
  credits     Int      @default(0)
  seed        String   @default("") // Deterministic RNG seed for run
  
  // Idle loop state
  shiftInProgress Boolean @default(false)
  shiftTick       Int     @default(0) // Current tick in shift
  shiftMaxTicks   Int     @default(75) // Default 75 seconds
  currentBiome    String? // Current shift biome
  currentDepth    Int     @default(1) // Current shift depth (1-3)
  
  // Four core meters
  heat            Float   @default(0) // 0-100%, throttle at 100%
  storageUsed     Int     @default(0) // Current storage units
  storageMax      Int     @default(20) // Base storage capacity
  wastePercent    Float   @default(0.15) // Base 15% waste rate
  throughputBase  Float   @default(1.0) // Units/tick base rate
  
  // Automation policy
  policySellUnits   String  @default("only_if_needed") // "always", "only_if_needed", "never"
  policyKeepSpecimens String @default("high_plus") // "high_plus", "keep_all", "keep_none"
  policyMeltLow     Boolean @default(false) // Melt low-grade specimens
  policyEmergency   Boolean @default(true) // Auto-liquidate if credits < due
  
  // Overclock state
  overclockActive Boolean @default(false)
  purgeCooldown   Int     @default(0) // Ticks until purge available
  
  // Daily upkeep from modules
  dailyUpkeep     Int     @default(0)
  
  stashSlots  Int      @default(12) // Current max slots
  stashSlotsUsed Int    @default(0) // Currently used slots
  slotUpgradeUsed Boolean @default(false) // Whether +4 slot upgrade was purchased
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dayStates   DayState[]
  stashItems  StashItem[]
  specimens   Specimen[]
  relics      OwnedRelic[]
  modules     RunModule[]
  shiftLogs   ShiftLog[]
}

model DayState {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  day         Int
  due         Int
  paid        Boolean  @default(false)
  
  // Idle shift system
  shiftCompleted  Boolean @default(false)
  biomeChosen     String? // Desert, Rift, Glacier
  depthChosen     Int?    // 1, 2, 3
  
  // Module draft state
  draftOffered    Json?   // Array of 3 module IDs offered
  draftChosen     String? // Module ID chosen
  
  // Repair state
  repairCost      Int     @default(0)
  repairPaid      Boolean @default(false)
  
  // Daily upkeep paid
  upkeepPaid      Int     @default(0)
  
  // Legacy fields (deprecated)
  shiftsUsed  Int      @default(0) // Deprecated
  depthTrackNode Int   @default(0) // Deprecated
  depthTrackExtracted Boolean @default(false) // Deprecated
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([runId, day])
}

model StashItem {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  metalType   String   // SOL, AES, VIR, LUN, NOC, CRN
  units       Int
  createdAt   DateTime @default(now())
}

model Specimen {
  id          String   @id @default(cuid())
  runId       String?
  run         Run?     @relation(fields: [runId], references: [id], onDelete: Cascade)
  metalType   String   // SOL, AES, VIR, LUN, NOC, CRN
  form        String   // Ore, Nugget, Coin, Bar
  grade       String   // Low, High, Ultra
  biome       String   // Desert, Rift, Glacier
  depth       Int      // 1, 2, or 3
  meltUnits   Int      // Calculated: baseUnits(form) * gradeMultiplier(grade)
  createdAt   DateTime @default(now())
}

model VaultSpecimen {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metalType   String
  form        String
  grade       String
  biome       String
  depth       Int
  meltUnits   Int
  createdAt   DateTime @default(now())
  depositedAt DateTime @default(now())
}

model VaultBalances {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credits     Int      @default(0)
  solUnits    Int      @default(0)
  aesUnits    Int      @default(0)
  virUnits    Int      @default(0)
  lunUnits    Int      @default(0)
  nocUnits    Int      @default(0)
  crnUnits    Int      @default(0)
  updatedAt   DateTime @updatedAt
}

model MarketPriceSnapshot {
  id          String   @id @default(cuid())
  sector      String   // A, B, or C
  metalType   String   // SOL, AES, VIR, LUN, NOC, CRN
  price       Float    // Base price in credits per unit
  timestamp   DateTime @default(now())

  @@index([sector, metalType, timestamp])
}

model SpecimenListing {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vaultSpecimenId String
  price       Int      // Credits asking price
  status      String   @default("active") // active, sold, cancelled
  createdAt   DateTime @default(now())
  soldAt      DateTime?
  lastRelistAt DateTime?
}

model Relic {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  rarity      Int      // Weight for random selection
  createdAt   DateTime @default(now())

  ownedRelics OwnedRelic[]
}

model OwnedRelic {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  runId       String?
  run         Run?     @relation(fields: [runId], references: [id], onDelete: Cascade)
  relicId     String
  relic       Relic    @relation(fields: [relicId], references: [id])
  used        Boolean  @default(false)
  usedAt      DateTime?
  createdAt   DateTime @default(now())
}

model MarketAnomaly {
  id          String   @id @default(cuid())
  sector      String   // A, B, or C
  metalType   String   // SOL, AES, VIR, LUN, NOC, CRN
  startTime   DateTime @default(now())
  endTime     DateTime // startTime + 30 seconds
  multiplier  Float    @default(1.25) // +25% sell price
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([sector, active, endTime])
}

model MarketDump {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metalType   String   // SOL, AES, VIR, LUN, NOC, CRN
  day         DateTime @default(now()) // Date (day level, not timestamp)
  unitsSold   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, metalType, day])
  @@index([userId, day])
}

// Module definitions (static, seeded)
model Module {
  id          String   @id @default(cuid())
  moduleId    String   @unique // e.g., "high_torque_drill"
  name        String   // Display name
  description String
  category    String   // extraction, cooling, sorting, refining, storage, market
  slotCost    Int      @default(1) // 1 or 2 slots
  rarity      String   @default("common") // common, uncommon, rare
  
  // Modifiers (all additive percentages or flat values)
  throughputMod      Float  @default(0) // +25% = 0.25
  heatGainMod        Float  @default(0) // +15% = 0.15
  wasteMod           Float  @default(0) // -20% = -0.20
  specimenChanceMod  Float  @default(0) // +3% = 0.03
  highGradeChanceMod Float  @default(0) // +10% = 0.10
  scrapToUnitsMod    Float  @default(0) // +10% = 0.10
  storageMod         Int    @default(0) // +6 = 6
  sellBidBonusMod    Float  @default(0) // +1% = 0.01
  volatilityMod      Float  @default(0) // -30% = -0.30
  upkeepCost         Int    @default(0) // Credits/day
  unitYieldMod       Float  @default(0) // -5% = -0.05
  jamChanceMod       Float  @default(0) // +3% = 0.03
  
  // Unlock condition (optional)
  unlockCondition String? // e.g., "journal_metal_SOL" - requires journal page complete
  
  createdAt   DateTime @default(now())
  
  runModules  RunModule[]
}

// Modules installed in a run
model RunModule {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id])
  slotIndex   Int      // Which slot(s) this occupies
  installedDay Int     // Day when installed
  createdAt   DateTime @default(now())
  
  @@index([runId])
}

// Log of shift results for each day
model ShiftLog {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  day         Int
  biome       String
  depth       Int
  
  // Production results
  unitsProduced   Json   // { SOL: 10, AES: 5, ... }
  specimensFound  Int    @default(0)
  scrapProduced   Int    @default(0)
  
  // Meter peaks
  heatMax         Float  @default(0)
  storageMax      Int    @default(0)
  wasteTotal      Float  @default(0)
  
  // Events
  heatThrottled   Boolean @default(false)
  damageFromHeat  Int     @default(0)
  purgesUsed      Int     @default(0)
  overclockTicks  Int     @default(0)
  
  // Policy results
  unitsSold       Int     @default(0)
  creditsSold     Int     @default(0)
  specimensMelted Int     @default(0)
  
  createdAt   DateTime @default(now())
  
  @@unique([runId, day])
}

